---
import Welcome from "../components/Welcome.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <div class="page-container">
    <div class="page-header">
      <h1>Push Notifications</h1>
      <p class="page-description">
        Enable push notifications to receive real-time updates
      </p>
    </div>

    <div class="content-grid">
      <div class="main-column">
        <div class="card">
          <div class="card-header">
            <h3>Your Client Information</h3>
          </div>
          <div class="card-body">
            <div class="client-id-display">
              <label>Client ID</label>
              <div class="client-id-value" id="clientIdValue">Loading...</div>
              <p class="help-text">
                This unique ID identifies your device for push notifications
              </p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Actions</h3>
          </div>
          <div class="card-body">
            <div class="button-group">
              <button id="enableNotifications" class="btn btn-primary">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                Enable Notifications
              </button>
              <button id="testWebhook" class="btn btn-secondary">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Test Notification
              </button>
            </div>
          </div>
        </div>

        <div id="status" class="status-message"></div>
      </div>

      <div class="sidebar">
        <div class="card">
          <div class="card-header">
            <h3>Recent Notifications</h3>
          </div>
          <div class="card-body">
            <ul id="notificationList" class="notification-list"></ul>
            <p class="empty-state" id="emptyState">
              No notifications yet. Enable notifications and send a test!
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Page-specific styles for index */
  .page-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
  }

  .page-header h1 {
    margin-bottom: var(--spacing-sm);
  }

  .page-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
  }

  .content-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: var(--spacing-xl);
    align-items: start;
  }

  @media (max-width: 968px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }

  .main-column {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .sidebar {
    position: sticky;
    top: calc(var(--spacing-2xl) + 60px);
  }

  .client-id-display {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .client-id-display label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .status-message {
    display: none;
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    animation: slideIn 0.3s ease;
  }

  .status-message.show {
    display: block;
  }

  .status-message.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
  }

  .status-message.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }

  .status-message.info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
  }

  .notification-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .notification-list:empty + .empty-state {
    display: block;
  }

  .notification-list:not(:empty) + .empty-state {
    display: none;
  }

  .notification-list li {
    padding: var(--spacing-md);
    background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    border-left: 4px solid var(--color-primary);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    animation: slideIn 0.3s ease;
  }

  .notification-list li strong {
    display: block;
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xs);
  }

  .timestamp {
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
    font-weight: 500;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  const statusDiv = document.getElementById("status");
  const enableBtn = document.getElementById("enableNotifications");
  const testBtn = document.getElementById("testWebhook");
  const notificationList = document.getElementById("notificationList");
  const clientIdValueSpan = document.getElementById("clientIdValue");

  let notificationPermission = Notification.permission;
  let swRegistration: ServiceWorkerRegistration | null = null;
  let pushSubscription: PushSubscription | null = null;
  let clientId: string | null = null;

  // Generate or retrieve client ID
  function getClientId(): string {
    let id = localStorage.getItem("clientId");
    if (!id) {
      id =
        "client-" +
        Math.random().toString(36).substring(2, 15) +
        Math.random().toString(36).substring(2, 15);
      localStorage.setItem("clientId", id);
    }
    return id;
  }

  clientId = getClientId();
  console.log("Client ID:", clientId);

  // Display client ID
  if (clientIdValueSpan) {
    clientIdValueSpan.textContent = clientId;
  }

  function updateStatus(message: string) {
    if (statusDiv) {
      statusDiv.textContent = message;
      statusDiv.className = "status-message show info";
      setTimeout(() => {
        statusDiv.classList.remove("show");
      }, 5000);
    }
  }

  function addNotificationToList(message: string, timestamp: string) {
    if (notificationList) {
      console.log("Adding notification to list:", message, timestamp);
      const li = document.createElement("li");
      li.innerHTML = `
				<div><strong>${message}</strong></div>
				<div class="timestamp">${new Date(timestamp).toLocaleString()}</div>
			`;
      notificationList.insertBefore(li, notificationList.firstChild);
    } else {
      console.error("notificationList element not found!");
    }
  }

  // Register Service Worker
  async function registerServiceWorker() {
    try {
      swRegistration = await navigator.serviceWorker.register("/sw.js");
      console.log("Service Worker registered:", swRegistration);
      return swRegistration;
    } catch (error) {
      console.error("Service Worker registration failed:", error);
      updateStatus("‚ùå Service Worker registration failed");
      throw error;
    }
  }

  // Subscribe to push notifications
  async function subscribeToPush(registration: ServiceWorkerRegistration) {
    try {
      // Get VAPID public key from server
      const response = await fetch("/api/vapid-public-key");
      const { publicKey } = await response.json();

      // Subscribe to push
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey),
      });

      console.log("Push subscription:", subscription);

      // Send subscription to server with client ID
      const saveResponse = await fetch("/api/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          subscription: subscription,
          clientId: clientId,
        }),
      });

      const result = await saveResponse.json();
      console.log("Subscription saved:", result);
      console.log("Your Client ID:", result.clientId);

      // Show client ID in status
      updateStatus(
        `‚úÖ Push notifications enabled! Your Client ID: ${result.clientId}`,
      );

      return subscription;
    } catch (error) {
      console.error("Push subscription failed:", error);
      throw error;
    }
  }

  // Convert VAPID key
  function urlBase64ToUint8Array(base64String: string) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding)
      .replace(/\-/g, "+")
      .replace(/_/g, "/");

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }

  // Enable notifications button
  enableBtn?.addEventListener("click", async () => {
    try {
      // Request notification permission
      const permission = await Notification.requestPermission();
      notificationPermission = permission;

      if (permission !== "granted") {
        updateStatus("‚ùå Notification permission denied");
        return;
      }

      updateStatus("üìù Setting up push notifications...");

      // Register service worker
      const registration = await registerServiceWorker();

      // Wait for service worker to be ready
      await navigator.serviceWorker.ready;

      // Subscribe to push
      pushSubscription = await subscribeToPush(registration);

      if (enableBtn) {
        enableBtn.textContent = "Push Notifications Enabled";
        (enableBtn as HTMLButtonElement).disabled = true;
      }
    } catch (error) {
      console.error("Error enabling notifications:", error);
      updateStatus("‚ùå Error enabling notifications: " + error);
    }
  });

  // Test webhook button
  testBtn?.addEventListener("click", async () => {
    try {
      const testMessage = prompt(
        "Enter a test message:",
        "Hello from webhook!",
      );
      if (!testMessage) return;

      updateStatus("üì§ Calling webhook...");

      // Call the webhook endpoint - it will trigger push notifications
      const response = await fetch(
        `/notification?text=${encodeURIComponent(testMessage)}`,
      );
      const data = await response.json();

      if (data.success) {
        addNotificationToList(data.message, data.timestamp);
        updateStatus(`‚úÖ Notification sent to ${data.sentTo} subscriber(s)!`);
      }
    } catch (error) {
      updateStatus("‚ùå Error calling webhook: " + error);
    }
  });

  // Check if service worker is already registered
  if ("serviceWorker" in navigator) {
    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener("message", (event) => {
      console.log("Message from service worker:", event.data);

      if (event.data.type === "PUSH_RECEIVED") {
        const notification = event.data.notification;
        console.log("Processing push notification:", notification);
        // Add to HTML list
        const message = notification.body || notification.data.message;
        const timestamp =
          notification.data.timestamp || new Date().toISOString();
        console.log("Extracted message:", message, "timestamp:", timestamp);
        addNotificationToList(message, timestamp);
      }
    });

    navigator.serviceWorker
      .getRegistration("/sw.js")
      .then(async (registration) => {
        if (registration) {
          console.log("Service Worker already registered");
          swRegistration = registration;

          // Check if already subscribed
          const subscription = await registration.pushManager.getSubscription();
          if (subscription) {
            pushSubscription = subscription;
            console.log("Already subscribed:", subscription);
            updateStatus("‚úÖ Push notifications already enabled");
            if (enableBtn) {
              enableBtn.textContent = "Push Notifications Enabled";
              (enableBtn as HTMLButtonElement).disabled = true;
            }
          } else {
            console.log("No existing subscription found");
            updateStatus(
              'Click "Enable Notifications" to receive push notifications',
            );
          }
        } else {
          console.log("No service worker registration found");
          updateStatus(
            'Click "Enable Notifications" to receive push notifications',
          );
        }
      });
  } else {
    updateStatus("‚ùå Push notifications not supported in this browser");
  }
</script>
