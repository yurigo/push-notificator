---
import Welcome from "../components/Welcome.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <h1>Enable Push Notifications</h1>

  <div class="container">
    <div
      id="clientIdDisplay"
      style="background: #f0f0f0; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; font-family: monospace;"
    >
      <strong>Your Client ID:</strong>
      <span id="clientIdValue">Loading...</span>
    </div>

    <button id="enableNotifications">Enable Notifications</button>
    <button id="testWebhook">Test Webhook</button>

    <div id="status"></div>

    <div id="notifications">
      <h2>Notifications:</h2>
      <ul id="notificationList"></ul>
    </div>
  </div>
</Layout>

<style>
  .container {
    max-width: 600px;
    margin: 2rem auto;
    padding: 2rem;
  }

  button {
    background: #4caf50;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 4px;
    cursor: pointer;
    margin: 0.5rem;
  }

  button:hover {
    background: #45a049;
  }

  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  #status {
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 4px;
    background: #f0f0f0;
  }

  #notifications {
    margin-top: 2rem;
  }

  #notificationList {
    list-style: none;
    padding: 0;
  }

  #notificationList li {
    background: #e3f2fd;
    padding: 1rem;
    margin: 0.5rem 0;
    border-radius: 4px;
    border-left: 4px solid #2196f3;
  }

  .timestamp {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.5rem;
  }
</style>

<script>
  const statusDiv = document.getElementById("status");
  const enableBtn = document.getElementById("enableNotifications");
  const testBtn = document.getElementById("testWebhook");
  const notificationList = document.getElementById("notificationList");
  const clientIdValueSpan = document.getElementById("clientIdValue");

  let notificationPermission = Notification.permission;
  let swRegistration: ServiceWorkerRegistration | null = null;
  let pushSubscription: PushSubscription | null = null;
  let clientId: string | null = null;

  // Generate or retrieve client ID
  function getClientId(): string {
    let id = localStorage.getItem("clientId");
    if (!id) {
      id =
        "client-" +
        Math.random().toString(36).substring(2, 15) +
        Math.random().toString(36).substring(2, 15);
      localStorage.setItem("clientId", id);
    }
    return id;
  }

  clientId = getClientId();
  console.log("Client ID:", clientId);

  // Display client ID
  if (clientIdValueSpan) {
    clientIdValueSpan.textContent = clientId;
  }

  function updateStatus(message: string) {
    if (statusDiv) {
      statusDiv.textContent = message;
    }
  }

  function addNotificationToList(message: string, timestamp: string) {
    if (notificationList) {
      console.log("Adding notification to list:", message, timestamp);
      const li = document.createElement("li");
      li.innerHTML = `
				<div><strong>${message}</strong></div>
				<div class="timestamp">${new Date(timestamp).toLocaleString()}</div>
			`;
      notificationList.insertBefore(li, notificationList.firstChild);
    } else {
      console.error("notificationList element not found!");
    }
  }

  // Register Service Worker
  async function registerServiceWorker() {
    try {
      swRegistration = await navigator.serviceWorker.register("/sw.js");
      console.log("Service Worker registered:", swRegistration);
      return swRegistration;
    } catch (error) {
      console.error("Service Worker registration failed:", error);
      updateStatus("‚ùå Service Worker registration failed");
      throw error;
    }
  }

  // Subscribe to push notifications
  async function subscribeToPush(registration: ServiceWorkerRegistration) {
    try {
      // Get VAPID public key from server
      const response = await fetch("/api/vapid-public-key");
      const { publicKey } = await response.json();

      // Subscribe to push
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey),
      });

      console.log("Push subscription:", subscription);

      // Send subscription to server with client ID
      const saveResponse = await fetch("/api/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          subscription: subscription,
          clientId: clientId,
        }),
      });

      const result = await saveResponse.json();
      console.log("Subscription saved:", result);
      console.log("Your Client ID:", result.clientId);

      // Show client ID in status
      updateStatus(
        `‚úÖ Push notifications enabled! Your Client ID: ${result.clientId}`,
      );

      return subscription;
    } catch (error) {
      console.error("Push subscription failed:", error);
      throw error;
    }
  }

  // Convert VAPID key
  function urlBase64ToUint8Array(base64String: string) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding)
      .replace(/\-/g, "+")
      .replace(/_/g, "/");

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }

  // Enable notifications button
  enableBtn?.addEventListener("click", async () => {
    try {
      // Request notification permission
      const permission = await Notification.requestPermission();
      notificationPermission = permission;

      if (permission !== "granted") {
        updateStatus("‚ùå Notification permission denied");
        return;
      }

      updateStatus("üìù Setting up push notifications...");

      // Register service worker
      const registration = await registerServiceWorker();

      // Wait for service worker to be ready
      await navigator.serviceWorker.ready;

      // Subscribe to push
      pushSubscription = await subscribeToPush(registration);

      if (enableBtn) {
        enableBtn.textContent = "Push Notifications Enabled";
        (enableBtn as HTMLButtonElement).disabled = true;
      }
    } catch (error) {
      console.error("Error enabling notifications:", error);
      updateStatus("‚ùå Error enabling notifications: " + error);
    }
  });

  // Test webhook button
  testBtn?.addEventListener("click", async () => {
    try {
      const testMessage = prompt(
        "Enter a test message:",
        "Hello from webhook!",
      );
      if (!testMessage) return;

      updateStatus("üì§ Calling webhook...");

      // Call the webhook endpoint - it will trigger push notifications
      const response = await fetch(
        `/notification?text=${encodeURIComponent(testMessage)}`,
      );
      const data = await response.json();

      if (data.success) {
        addNotificationToList(data.message, data.timestamp);
        updateStatus(`‚úÖ Notification sent to ${data.sentTo} subscriber(s)!`);
      }
    } catch (error) {
      updateStatus("‚ùå Error calling webhook: " + error);
    }
  });

  // Check if service worker is already registered
  if ("serviceWorker" in navigator) {
    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener("message", (event) => {
      console.log("Message from service worker:", event.data);

      if (event.data.type === "PUSH_RECEIVED") {
        const notification = event.data.notification;
        console.log("Processing push notification:", notification);
        // Add to HTML list
        const message = notification.body || notification.data.message;
        const timestamp =
          notification.data.timestamp || new Date().toISOString();
        console.log("Extracted message:", message, "timestamp:", timestamp);
        addNotificationToList(message, timestamp);
      }
    });

    navigator.serviceWorker
      .getRegistration("/sw.js")
      .then(async (registration) => {
        if (registration) {
          console.log("Service Worker already registered");
          swRegistration = registration;

          // Check if already subscribed
          const subscription = await registration.pushManager.getSubscription();
          if (subscription) {
            pushSubscription = subscription;
            console.log("Already subscribed:", subscription);
            updateStatus("‚úÖ Push notifications already enabled");
            if (enableBtn) {
              enableBtn.textContent = "Push Notifications Enabled";
              (enableBtn as HTMLButtonElement).disabled = true;
            }
          } else {
            console.log("No existing subscription found");
            updateStatus(
              'Click "Enable Notifications" to receive push notifications',
            );
          }
        } else {
          console.log("No service worker registration found");
          updateStatus(
            'Click "Enable Notifications" to receive push notifications',
          );
        }
      });
  } else {
    updateStatus("‚ùå Push notifications not supported in this browser");
  }
</script>
