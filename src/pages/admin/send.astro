---
import Layout from "../../layouts/Layout.astro";
---

<Layout>
  <div class="page-container">
    <div class="page-header">
      <h1>Send Notifications</h1>
      <p class="page-description">
        Send push notifications to individual clients or broadcast to all
      </p>
    </div>

    <div class="content-layout">
      <div class="form-card card">
        <div class="card-header">
          <h3>Compose Notification</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="clientSelect" class="form-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Select Recipient
            </label>
            <div class="select-group">
              <select id="clientSelect" class="form-select">
                <option value="">Loading clients...</option>
              </select>
              <button id="refreshClients" class="btn-icon" title="Refresh">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path
                    d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <div class="client-info" id="clientInfo"></div>

          <div class="form-group">
            <label for="messageText" class="form-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              Message
            </label>
            <textarea
              id="messageText"
              class="form-textarea"
              placeholder="Enter your notification message..."
              rows="6"></textarea>
            <div class="help-text">
              Tip: Press Ctrl+Enter to send quickly
            </div>
          </div>

          <button id="sendBtn" class="btn btn-primary btn-large">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Send Notification
          </button>

          <div id="status" class="status-message"></div>
        </div>
      </div>

      <div class="history-card card">
        <div class="card-header">
          <h3>Recent Activity</h3>
        </div>
        <div class="card-body">
          <div id="history"></div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Page-specific styles for admin send page */
  .page-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
  }

  .page-header h1 {
    margin-bottom: var(--spacing-sm);
  }

  .page-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
  }

  .content-layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: var(--spacing-xl);
    align-items: start;
  }

  @media (max-width: 968px) {
    .content-layout {
      grid-template-columns: 1fr;
    }
  }

  .form-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .form-label svg {
    color: var(--color-primary);
  }

  .select-group {
    display: flex;
    gap: var(--spacing-sm);
  }

  .form-select {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 1rem;
    background: var(--color-surface);
    color: var(--color-text-primary);
    transition: all 0.2s ease;
  }

  .form-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .btn-large {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1.125rem;
  }

  .btn-icon {
    padding: 0.5rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-icon:hover {
    background: var(--color-bg-secondary);
    border-color: var(--color-primary);
  }

  .btn-icon svg {
    color: var(--color-text-secondary);
  }

  .btn-icon:hover svg {
    color: var(--color-primary);
  }

  .client-info {
    background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-lg);
    font-size: 0.875rem;
    border: 1px solid #c4b5fd;
    display: none;
  }

  .client-info.visible {
    display: block;
    animation: slideIn 0.3s ease;
  }

  .client-info strong {
    color: var(--color-text-primary);
  }

  .status-message {
    margin-top: var(--spacing-md);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    display: none;
  }

  .status-message.visible {
    display: block;
    animation: slideIn 0.3s ease;
  }

  .status-message.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
  }

  .status-message.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }

  .history-card {
    position: sticky;
    top: calc(var(--spacing-2xl) + 60px);
    max-height: calc(100vh - var(--spacing-2xl) - 100px);
    overflow-y: auto;
  }

  .history-item {
    background: var(--color-bg-secondary);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-primary);
    animation: slideIn 0.3s ease;
  }

  .history-time {
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
    font-weight: 500;
  }

  .history-client {
    font-weight: 600;
    color: var(--color-primary);
    font-family: var(--font-mono);
    font-size: 0.875rem;
    margin: var(--spacing-xs) 0;
  }

  .history-message {
    margin-top: var(--spacing-sm);
    font-style: italic;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .empty-history {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-text-tertiary);
    font-size: 0.875rem;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  const clientSelect = document.getElementById(
    "clientSelect",
  ) as HTMLSelectElement;
  const refreshBtn = document.getElementById("refreshClients");
  const messageText = document.getElementById(
    "messageText",
  ) as HTMLTextAreaElement;
  const sendBtn = document.getElementById("sendBtn") as HTMLButtonElement;
  const statusDiv = document.getElementById("status");
  const clientInfoDiv = document.getElementById("clientInfo");
  const historyDiv = document.getElementById("history");

  let clients: any[] = [];
  let sendHistory: any[] = [];

  async function loadClients() {
    try {
      const response = await fetch("/api/subscribe");
      const data = await response.json();
      clients = data.clients || [];

      // Update dropdown
      clientSelect.innerHTML =
        '<option value="">-- Select a client --</option>';
      clientSelect.innerHTML +=
        '<option value="BROADCAST">ðŸ”Š BROADCAST TO ALL</option>';

      clients.forEach((client: any) => {
        const option = document.createElement("option");
        option.value = client.fullId;
        option.textContent = `${client.id} (Connected: ${new Date(
          client.connectedAt,
        ).toLocaleString()})`;
        clientSelect.appendChild(option);
      });

      if (clients.length === 0) {
        clientSelect.innerHTML +=
          '<option value="">No clients connected</option>';
      }
    } catch (error) {
      console.error("Error loading clients:", error);
      clientSelect.innerHTML =
        '<option value="">Error loading clients</option>';
    }
  }

  function showClientInfo() {
    const selectedValue = clientSelect.value;

    if (!selectedValue || selectedValue === "") {
      if (clientInfoDiv) {
        clientInfoDiv.classList.remove("visible");
      }
      return;
    }

    if (selectedValue === "BROADCAST") {
      if (clientInfoDiv) {
        clientInfoDiv.innerHTML = `
          <strong>ðŸ“¡ Broadcast Mode</strong><br>
          This notification will be sent to <strong>ALL ${clients.length} connected client(s)</strong>.
        `;
        clientInfoDiv.classList.add("visible");
      }
      return;
    }

    const client = clients.find((c) => c.fullId === selectedValue);
    if (client && clientInfoDiv) {
      clientInfoDiv.innerHTML = `
        <strong>Client ID:</strong> ${client.fullId}<br>
        <strong>Connected:</strong> ${new Date(client.connectedAt).toLocaleString()}<br>
        <strong>Last Seen:</strong> ${new Date(client.lastSeen).toLocaleString()}<br>
        ${client.userAgent ? `<strong>User Agent:</strong> ${client.userAgent}` : ""}
      `;
      clientInfoDiv.classList.add("visible");
    }
  }

  function showStatus(message: string, type: "success" | "error") {
    if (statusDiv) {
      statusDiv.textContent = message;
      statusDiv.className = `visible ${type}`;
      setTimeout(() => {
        statusDiv.classList.remove("visible");
      }, 5000);
    }
  }

  function addToHistory(
    clientId: string,
    message: string,
    result: any,
    broadcast: boolean,
  ) {
    const historyItem = {
      time: new Date().toISOString(),
      clientId: broadcast ? "BROADCAST" : clientId,
      message: message,
      sentTo: result.sentTo || 0,
      broadcast: broadcast,
    };

    sendHistory.unshift(historyItem);
    if (sendHistory.length > 10) sendHistory.pop(); // Keep last 10

    updateHistoryDisplay();
  }

  function updateHistoryDisplay() {
    if (!historyDiv) return;

    if (sendHistory.length === 0) {
      historyDiv.innerHTML = '<div class="empty-history">No notifications sent yet.</div>';
      return;
    }

    historyDiv.innerHTML = sendHistory
      .map(
        (item) => {
          const clientsText = item.sentTo === 1 ? 'client' : 'clients';
          return `
      <div class="history-item">
        <div class="history-time">${new Date(item.time).toLocaleString()}</div>
        <div class="history-client">
          ${item.broadcast ? "ðŸ”Š BROADCAST" : item.clientId}
          ${item.broadcast ? ` (${item.sentTo} ${clientsText})` : ""}
        </div>
        <div class="history-message">"${item.message}"</div>
      </div>
    `;
        },
      )
      .join("");
  }

  async function sendNotification() {
    const clientId = clientSelect.value;
    const message = messageText.value.trim();

    if (!clientId || clientId === "") {
      showStatus("Please select a client", "error");
      return;
    }

    if (!message) {
      showStatus("Please enter a message", "error");
      return;
    }

    try {
      sendBtn.disabled = true;
      sendBtn.textContent = "Sending...";

      const isBroadcast = clientId === "BROADCAST";
      let url = `/notification?text=${encodeURIComponent(message)}`;
      if (!isBroadcast) {
        url += `&id=${encodeURIComponent(clientId)}`;
      }

      const response = await fetch(url);
      const result = await response.json();

      if (result.success) {
        showStatus(
          `âœ… Notification sent successfully to ${result.sentTo} client(s)!`,
          "success",
        );
        addToHistory(clientId, message, result, isBroadcast);
        messageText.value = ""; // Clear textarea
      } else {
        showStatus("âŒ Failed to send notification", "error");
      }
    } catch (error) {
      console.error("Error sending notification:", error);
      showStatus("âŒ Error sending notification: " + error, "error");
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = "Send Notification";
    }
  }

  // Event listeners
  refreshBtn?.addEventListener("click", loadClients);
  clientSelect?.addEventListener("change", showClientInfo);
  sendBtn?.addEventListener("click", sendNotification);

  // Allow Ctrl+Enter to send
  messageText?.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key === "Enter") {
      sendNotification();
    }
  });

  // Initial load
  loadClients();
  updateHistoryDisplay();
</script>
